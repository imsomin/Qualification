# SQL응용

## (7-1) 데이터베이스 기본

### 1. 트랜잭션(Transaction)
- 인가받지 않은 사용자로부터 데이터를 보장하기 위해 DBMS가 가져야 하는 특성이자, 데이터베이스 시스템에서 하나의 논리적 기능을 정상적으로 수행하기 위한 작업의 기본 단위
- 특성 : 원자성(Rollback, Commit), 일관성(무결성 제약조건), 격리성(Serializable), 영속성(회복기법)
- 상태
  - 활동 상태(Active): 초기 상태, 트랜잭션이 실행 중일 때 가지는 상태 
  - 부분 완료 상태(Partially Committed): 마지막 명령문이 실행된 후에 가지는 상태
  - 완료 상태(Committed): 트랜잭션이 성공적으로 완료된 후 가지는 상태
  - 실패 상태(Failed): 정상적인 실행이 더 이상 진행될 수 없을 때 가지는 상태
  - 철회 상태(Aborted): 트랜잭션이 취소되고 데이터베이스가 트랜잭션 시작 전 상태로 환원된 상태


### 1-1. 트랜잭션 제어
- 트랜잭션 제어언어는 TCL(Transaction Control Language)이라고 하며, 트랜잭션의 결과를 허용하거나 취소하는 목적으로 사용되는 언어를 지칭한다.
- TCL 명령어
  - 커밋: 트랜잭션 확정
  - 롤백: 트랜잭션 취소
  - 체크포인트: 저장 시기 설정


### 1-2. 병행 제어(일관성 주요 기법)
- 병행제어(Concurrency Control)는 다수 사용자 환경에서 여러 트랜잭션을 수행할 때, 데이터베이스 일관성 유지를 위해 상호작용을 제어하는 기법이다.
- 목적: 데이터베이스 공유 최대화, 시스템 활용도 최대화, 데이터베이스 일관성 유지, 사용자에 대한 응답시간 최소화
- 병행제어 미보장 시 문제점
  - 갱신 손실(Lost Update)
  - 현황 파악오류(Dirty Read)
  - 모순성(Inconsistency)
  - 연쇄복귀(Cascading Rollback)
- 병행제어 기법의 종류
  - 로킹(Locking): 트랜잭션의 순차적 진행을 보장하는 직렬화 기법
    - 로킹의 특징
      - 데이터베이스, 파일, 레코드 등을 로킹 단위가 될 수 있음
      - 로킹 단위가 작아지면 데이터베이스 공유도가 증가
      - 로킹 단위가 작아지면 로킹 오버헤드 증가
      - 한꺼번에 로킹할 수 있는 객체의 크기를 로킹 단위라고 함
  - 낙관적 검증: 트랜잭션이 어떠한 검증 수행 없이 수행된 뒤, 트랜잭션이 종료 시 검증을 수행하여 데이터베이스에 반영하는 기법
  - 타임 스탬프 순서(Time Stamp Ordering): 트랜잭션과 트랜잭션이 읽거나 갱신한 데이터에 대해, 트랜잭션이 실행되기 전 타임 스탬프를 부여하여 부여된 시간에 따라 트랜잭션을 수행하는 기법
  - 다중버전 동시성 제어(MVCC; Multi Version Concurrency Control): 트랜잭션의 타임스탬프와 접근하려는 데이터의 타임스탬프를 비교하여 직렬가능성이 보장되는 적절한 버전을 선택하여 접근하도록 하는 기법


### 1-3. 데이터베이스 고립화 수준(격리성 주요 기법)
- 고립화 수준(Isolation Level): 다른 트랜잭션이 현재의 데이터에 대한 무결성을 해치지 않기 위해 잠금을 설정하는 정도
- 종류
  - Read Uncommitted: 한 트랜잭션에서 연산 중인 데이터를 다른 트랜잭션이 읽는 것을 허용하는 수준
  - Read Committed: 한 트랜잭션에서 연산을 수행할 때, 연산이 완료될 때까지 데이터에 대한 읽기를 제한하는 수준
  - Repeatable Read: 선행 트랜잭션이 특정 데이터를 읽을 때, 트랜잭션 종료 시까지 해당 데이터에 대한 갱신을 제한하는 수준
  - Serializable Read: 선행 트랜잭션이 특정 데이터 영역을 순차적으로 읽을 때, 해당 데이터에 대한 접근을 제한하는 수준


### 1-4. 회복 기법(영속성 주요 기법)
- 회복 기법(Recovery): 트랜잭션을 수행하는 도중 장애로 인해 손상된 데이터베이스를 손상되기 이전의 정상적인 상태로 복구시키는 작업
- 종류
  - 로그 기반 회복 기법
    - 지연 갱신 회복 기법: 트랜잭션이 완료되기 전까지 데이터베이스에 기록하지 않는 기법
    - 즉각 갱신 회복 기법: 트랜잭션 수행 중 갱신 결과를 바로 DB에 반영하는 기법
  - 체크 포인트 회복 기법: 장애 발생 시 검사점 이후에 처리된 트랜잭션에 대해서만 장애 발생 이전의 상태로 복원시키는 회복 기법
  - 그림자 페이징 회복 기법: 데이터베이스 트랜잭션 수행 시 복제본을 생성하여 데이터베이스 장애 시 이를 이용해 복구하는 기법


### 2. 데이터 정의어, DDL(Data Definition Language)
- 데이터 정의어는 데이터를 정의하는 언어로서 '데이터를 담는 그릇을 정의하는 언어'이다.
- 테이블과 같은 데이터 구조를 정의하는 데 사용되는 명령어들로 특정 구조를 생성, 변경, 삭제, 이름을 바꾸는 데이터 구조와 관련된 명령어들을 데이터 정의어라고 부른다.
- DDL 대상
  - 도메인: 하나의 속성이 가질 수 있는 원자값들의 집합, 속성의 데이터 타입과 크기 및 제약조건 등의 정보
  - 스키마: 데이터베이스의 구조, 제약조건 등의 정보를 담고 있는 기본적인 구조
    - 외부 스키마: 사용자나 개발자의 관점에서 필요로 하는 데이터베이스의 논리적 구조
    - 개념 스키마: 데이터베이스의 전체적인 논리적 구조
    - 내부 스키마: 물리적 저장장치의 관점에서 보는 데이터베이스 구조
  - 테이블: 데이터 저장 공간
  - 뷰: 하나 이상의 물리 테이블에서 유도되는 가상의 테이블
  - 인덱스: 검색을 빠르게 하기 위한 데이터 구조


### 2-1. 인덱스(Index)
- 인덱스는 데이터를 빠르게 찾을 수 있는 수단으로서, 테이블에 대한 조회 속도를 높여 주는 자료 구조이다.
- 인덱스는 테이블의 특정 레코드 위치를 알려 주는 용도로 사용한다.
- 특징
  - 기본 키(PK; Primary Key) 컬럼은 자동으로 인덱스가 생성된다.
  - 연월일이나 이름을 기준으로 하는 인덱스는 자동으로 생성되지 않는다.
  - 테이블의 컬럼에 인덱스가 없는 경우, 테이블의 전체 내용을 검색한다.(테이블 전체 스캔; Table Full Scan)
  - 인덱스가 생성되어 있을 때 데이터를 빠르게 찾을 수 있다(인덱스 범위 스캔; Index Range Scan)
  - 조건절에 '='로 비교되는 컬럼을 대상으로 인덱스를 생성하면 검색 속도를 높일 수 있다.
- 종류
  - 순서 인덱스
  - 해시 인덱스
  - 비트맵 인덱스
  - 함수기반 인덱스
  - 단일 인덱스
  - 결합 인덱스
  - 클러스터드 인덱스


### 2-2. DDL 명령어
- CREATE
- ALTER
- DROP
- TRUNCATE


### 2-3. INDEX 관련 DDL
- CREATE INDEX : 인덱스를 생성하는 명령
  - UNIQUE는 생략 가능하고, 인덱스 걸린 컬럼에 중복 값을 허용하지 않는다.
  - 복수 컬럼을 인덱스로 걸 수 있다.
  - 문법 : CREATE [ UNIQUE ] INDEX 인덱스명 ON 테이블명(컬럼명1, 컬럼명2, ...);
- ALTER INDEX : 인덱스를 수정하는 명령
  - 일부 DBMS는 ALTER INDEX를 제공하지 않는다.
  - 기존 인덱스를 삭제하고 신규 인덱스를 생성하는 방식으로 사용을 권고한다.
  - 문법 : ALTER [ UNIQUE ] INDEX 인덱스명 ON 테이블명(컬럼명1, 컬럼명2, ...);
- DROP INDEX : 인덱스를 삭제하는 명령
  - 문법 : DROP INDEX 인덱스명;


### 3. 데이터 조작어, DML(Data Manipulation Language)
- 데이터 조작어는 데이터베이스에 저장된 자료들을 입력, 수정, 삭제, 조회하는 언어이다.
- 유형
  - SELECT
  - INSERT
  - UPDATE
  - DELETE


### 3-1. SELECT(데이터 조회) 명령어
- 데이터의 내용을 조회할 때 사용하는 명령어로 SELECT절, FROM절, WHERE절, GROUP BY 절, HAVING 절, ORDER BY 절로 구성됨
- 1 조인(join)
  - 조인은 두 개 이상의 테이블을 연결하여 데이터를 검색하는 방법이다.
  - 두 릴레이션으로부터 관련된 튜플들을 결합하여 하나의 튜플로 만드는 가장 대표적인 데이터 연결 방법
  - 논리적 조인 유형
    - 내부 조인(inner join)
    - 외부 조인(outer join)
    - 교차 조인(cross join)
    - 셀프 조인(self join)
- 2 서브쿼리(Sub-Query)
  - 서브쿼리는 SQL문 안에 포함된 또 다른 SQL문이다.
  - 서브쿼리의 용도는 알려지지 않은 기준을 위한 검색을 위해 사용한다.
  - 메인쿼리와 서브쿼리 관계는 주종 관계로서, 서브쿼리에 사용되는 컬럼 정보는 메인쿼리의 컬럼 정보를 사용할 수는 있으나 역으로는 성립하지 않음
  - 서브쿼리 유형
    - SELECT 절 서브쿼리: 스칼라 서브쿼리(Scalar Sub-Query), 단일 행을 리턴해야 함, 집계함수가 많이 쓰임 
    - FROM 절 서브쿼리: 인라인 뷰(Inline Views), 뷰처럼 결과가 동적으로 생성된 테이블 형태로 사용 가능
    - WHERE 절 서브쿼리: 중첩 서브쿼리(Nested Sub-Query)
- 3 집합 연산자(Set Operator)
  - 집합 연산자는 테이블을 집합 개념으로 보고, 두 테이블 연산에 집합 연산자를 사용하는 방식이다.
  - 집합 연산자는 2개 이상의 질의 결과를 하나의 결과로 만들어 준다.
  - 집합 연산자 유형
    - UNION: 중복 행이 제거된 쿼리 결과를 반환하는 집합 연산자
    - UNION ALL: 중복 행이 제거되지 않은 쿼리 결과를 반환하는 집합 연산자
    - INTERSECT
    - MINUS


### 4. 데이터 제어어, DCL(Data Control Language)
- 데이터 제어어는 데이터베이스 관리자가 데이터 보안, 무결성 유지, 병행 제어, 회복을 위해 관리자(DBA)가 사용하는 제어용 언어이다.
- 유형
  - GRANT: 사용 권한 부여 -> GRANT 권한 ON 테이블 TO 사용자;
  - REVOKE: 사용 권한 취소 -> REVOKE 권한 ON 테이블 FROM 사용자;
  

___



## (7-2) 응용 SQL 작성하기

### 1. 데이터 분석 함수
- 집계 함수
  - COUNT
  - SUM
  - AVG
  - MAX
  - MIN
  - STDDEV
  - VARIAN
- 그룹 함수
  - ROLLUP
  - CUBE
  - GROUPING SETS
- 윈도 함수
  - 데이터베이스를 사용한 온라인 분석 처리 용도로 사용하기 위해서 표준 SQL에 추가된 함수
  

___



## (7-3) 절차형 SQL 활용하기

### 1. 절차형 SQL(Procedural Language)
- 일반적인 개발 언어처럼 SQL 언어에서도 절차 지향적인 프로그램이 가능하도록 하는 트랜잭션 언어
- 종류
  - 프로시저(Procedure): 일련의 쿼리들을 마치 하나의 함수처럼 실행하기 위한 쿼리의 집합
  - 사용자 정의 함수(User-Defined Function): 일련의 SQL 처리를 수행하고, 수행 결과를 단일 값으로 반환할 수 있는 절차형 SQL
  - 트리거(Trigger): 데이터베이스 시스템에서 삽입/갱신/삭제 등의 이벤트 발생 시 관련 작업이 자동으로 수행되는 절차형 SQL


### 1-1. 출력부
- DBMS_OUTPUT
  - 메시지를 버퍼에 저장하고 버퍼로부터 메시지를 읽어오기 위한 인터페이스 패키지
  - 절차형 SQL이 정상적으로 구현되었는지 테스트하는 목적으로 많이 사용됨
- 종류
  - DBMS_OUTPUT.PUT(문자열); : 개행없이 문자열을 출력하는 프로시저
  - DBMS_OUTPUT.PUT_LINE(문자열); : 문자열을 출력 후 개행하는 프로시저


### 1-2. 제어부(CONTROL)
- 조건문
  - IF 문
  - 간단한 케이스 문: CASE 변수 WHEN 값1 THEN SET 명령어; WHEN 값2 THEN SET 명령어; ... ELSE SET 명령어; END CASE;
  - 검색된 케이스 문: CASE WHEN 조건1 THEN SET 명령어; WHEN 조건2 THEN SET 명령어; ... ELSE SET 명령어; END CASE;
- 반복문
  - LOOP 문: LOOP 문장; EXIT WHEN 탈출조건; END LOOP;
  - WHILE 문: WHILE 반복조건 LOOP 문장; EXIT WHEN 탈출조건; END LOOP;
  - FOR LOOP 문: FOR 인덱스 IN 시작값..종료값 LOOP 문장 END LOOP;


### 1-3. 예외부(EXCEPTION)
- 실행 중 발생 가능한 예외상황을 수행하는 부분
- EXCEPTION WHEN 조건 THEN SET 명령어;


### 2. 프로시저
- 프로시저는 일련의 쿼리들을 마치 하나의 함수처럼 실행하기 위한 쿼리의 집합이다.
- 구성
  - 선언부(DECLARE): 프로시저의 명칭, 변수와 인수, 그에 대한 데이터 타입을 정의하는 부분
  - 시작/종료부(BEGIN/END): 프로시저의 시작과 종료를 표현
  - 제어부(CONTROL): 기본적으로는 순차적으로 처리
  - SQL: DML을 주로 사용
  - 예외부(EXCEPTION): 예외 발생 시 예외 처리 방법 정의
  - 실행부(TRANSACTION): 프로시저에서 수행된 DML 수행 내역의 DBMS의 적용 또는 취소 여부를 결정하는 처리부
- 문법  
  CREATE [ OR REPLACE ] PROCEDURE 프로시저_명  
  (파라미터_명 [ IN | OUT | INOUT ] 데이터_타입, ...)  
  IS  
    변수선언  
  BEGIN  
    명령어;  
  [ COMMIT | ROLLBACK ]  
  END;  
- 모드(IN/OUT/INOUT) : 변수의 입출력을 구분하는 역할
  - IN : 운영체제에서 프로시저로 값을 전달하는 모드
  - OUT : 프로시저에서 처리된 결과를 운영체제로 전달하는 모드
  - INOUT : IN과 OUT의 두 가지 기능을 동시에 수행하는 모드
- 프로시저 호출문
  - SQL TOOL을 활용하여 직접 실행시키는 경우, EXECUTE 또는 EXEC 명령어를 이용하여 프로시저 실행
  - 프로시저에 입출력 변수가 존재하는 경우, 변수를 입력해야 한다.
  - SQL> EXECUTE 프로시저_명 (파라미터_1, 파라미터_2, ...);
  - 예시) >EXECUTE SALES_CLOSING('12345678'); : 변수에 12345678이라는 값 전달


### 3. 사용자 정의함수
- 사용자 정의함수는 일련의 SQL 처리를 수행하고, 수행 결과를 단일 값으로 반환할 수 있는 절차형 SQL이다.
- 기본적인 사항은 프로시저와 동일하고 실행부가 아닌 반환부(RETURN)가 있다는 점이 프로시저와 다르다.
- 종료시 단일 값을 반환한다.
- 문법  
  CREATE [ OR REPLACE ] FUNCTION 함수_명  
  (파라미터_명 [ IN ] 데이터_타입, ...)  
  RETURN 데이터_타입  
  IS  
    변수선언  
  BEGIN  
    명령어;  
  RETURN 변수;   
  END;    


### 4. 트리거
- 트리거는 데이터베이스 시스템에서 삽입/갱신/삭제 등의 이벤트 발생 시 관련 작업이 자동으로 수행되는 절차형 SQL이다.
- 이벤트는 전체 트랜잭션 대상과 각행에 의해 발생하는 경우 모두를 포함할 수 있으며 테이블과 뷰, DB작업을 대상으로 정의할 수 있다.
- 특정 테이블에 대한 데이터 벼경을 시작점으로 설정하고, 그와 관련된 작업을 자동적으로 수행하기 위해 트리거를 사용한다.
- 데이터 무결성 유지 및 로그 메시지 출력 등의 별도 처리를 위해 트리거를 사용한다.
- 반환 값이 없으며, DML을 주된 목적으로 한다.
- EVENT 명령어를 통해 트리거 실행을 위한 이벤트를 인지하며, 외부 변수가 없다.
- 종류
  - 행 트리거 : 데이터 변화가 생길 때마다 실행
  - 문장 트리거 : 트리거에 의해 단 한번 실행
- 문법  
  CREATE [ OR REPLACE ] TRIGGER 트리거명  
  [ BEFORE | AFTER ] 유형 ON 테이블명    
  [ FOR EACH ROW ]    
  BEGIN   
  END;  
- 트리거 순서
  - BEFORE: 테이블명에 대한 삽입/갱신/삭제 를 수행하기 전에 트리거가 실행하도록 지정하는 명령
  - AFTER: 테이블명에 대한 삽입/갱신/삭제 가 성공적으로 실행되었을 때만 트리거가 실행하도록 지정하는 명령
- FOR EACH ROW : 매번 변경되는 데이터 행의 수만큼 실행을 위한 명령어
- 트리거 주의사항
  - TCL 사용불가 : 트리거 내에는 커밋, 롤백 등의 트랜잭션 제어어 사용 시 컴파일 에러 발생 
  - 오류에 주의 : 트리거 실행 중 오류가 발생하게 되면 트리거 실행의 원인을 제공한 데이터 작업에도 영향 존재
 

___



## (7-4) 데이터 조작 프로시저 최적화

### 1. 쿼리 성능 개선(튜닝)
- 쿼리 성능 개선은 데이터베이스에서 프로시저에 있는 SQL 실행 계획을 분석, 수정을 통해 최소의 시간으로 원하는 결과를 얻도록 프로시저를 수정하는 작업
- SQL 성능 개선을 통해 데이터 조작 프로시저의 성능 개선이 가능함
- 성능 개선 절차
  - 1 문제 있는 SQL 식별
  - 2 옵티마이저 통계 확인
  - 3 SQL문 재구성
  - 4 인덱스 재구성
  - 5 실행계획 유지관리


### 2. 옵티마이저(Optimizer)
- 옵티마이저는 SQL을 가장 빠르고 효울적으로 수행할 최적의 처리경로를 생성해주는 DBMS 내부의 핵심엔진이다.


### 2-1. 옵티마이저의 유형
- RBO(Rule Based Optimizer): 통계 정보가 없는 상태에서 사전 등록된 규칙에 따라 질의 실행 계획을 선택하는 옵티마이저
- CBO(Cost Based Optimizer): 통계 정보로부터 모든 접근 경로를 고려한 질의실행 계획을 선택하는 옵티마이저
  |비교|규칙기반 옵티마이저|비용기반 옵티마이저|
  |:--:|:--:|:--:|
  |핵심|규칙(우선 순위) 기반|비용(수행 시간)기반|
  |평가기준|인덱스 구조, 연산자, 조건절 형태 등|레코드 개수, 블록 개수, 평균 행 길이, 컬럼 값 수 등|
  |장점|사용자가 원하는 처리경로로 유도 용이|옵티마이저의 이해도가 낮아도 성능보장 가능|


### 2-2. SQL 수행과정 내 옵티마이저 역할
- 쿼리 변환 : SQL을 좀 더 일반적이고 표준화된 형태로 변환
- 비용 산정 : 쿼리 명령어 각 단계의 선택도, 카디널리티, 비용을 계산
- 게획 생성 : 하나의 쿼리를 수행 시 후보군이 될 만한 실행계획들을 생성해내는 역할
- (추가 개념)
  - 선택도: 전체 대상 레코드 중에서 특정 조건에 의해 선택될 것으로 예상되는 레코드 비율


### 3. 힌트 사용
- 힌트(Hint)란, 실행하려 하는 SQL 문에 사전에 정보를 주어서 SQL 문 실행에 빠른 결과를 가져오는 효과를 만드는 문법이다.
- SQL 성능 개선의 핵심 부분으로 옵티마이저의 실행 계획을 원하는 대로 변경할 수 있게 한다.
- 옵티마이저가 항상 최선의 실행 계획을 수립할 수 없어 명시적인 힌트를 통해 실행계획을 변경한다.
- 사용 예시  
  SELECT /*+ RULE */ ENAME, SAL  
  FROM EMP  
  WHERE EMPNO > 9000;  
  -> 비용기반 옵티마이저에서 규칙기반 옵티마이저 모드로 변경 수행
- 주요 옵티마이저 힌트
  - /*+ RULE */ : 규칙 기반 접근 방식 사용 지정
  - /*+ CHOOSE */ : 오라클 옵티마이저 디폴트 값에 따름
  - /*+ INDEX(테이블명 인덱스명) */ : 지정된 인덱스를 강제적으로 사용하도록 지정
  - /*+ USE_HASH(테이블명) */ : 지정 테이블들의 조인이 HASH JOIN 형식으로 일어나도록 유도
  - /*+ USE_MERGE(테이블명) */ : 지정 테이블들의 조인이 SORT MERGE 형식으로 일어나도록 유도
  - /*+ USE_NL(테이블명) */ : 지정 테이블들의 조인이 NESTED LOOP 형식으로 일어나도록 유도


### 4. SQL 문 재구성 가이드
- 특정 값 지정
- 별도의 SQL 사용
- 힌트 사용
- HAVING 미사용
- 인덱스만 질의 사용


### 5. 인덱스 재구성 가이드
- 자주 쓰는 컬럼 선정
- SORT 명령어 생략
- 분포도를 고려
- 변경 적은 컬럼 선정
- 결합 인덱스 사용